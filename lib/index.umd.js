!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).blindnet={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,n)};function n(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return(r=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function i(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function o(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function s(t){return new Promise(((e,n)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>n(t.error)}))}function a(t,e){const n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var e=function(){return indexedDB.databases().finally(t)};r=setInterval(e,100),e()})).finally((function(){return clearInterval(r)})):Promise.resolve()).then((()=>{const n=indexedDB.open(t);return n.onupgradeneeded=()=>n.result.createObjectStore(e),s(n)}));var r;return(t,r)=>n.then((n=>r(n.transaction(e,t).objectStore(e))))}let c;function u(){return c||(c=a("keyval-store","keyval")),c}function f(t,e=u()){return e("readonly",(e=>s(e.get(t))))}var d=function(t,e){var n=this;void 0===t&&(t="blindnet"),void 0===e&&(e="keys"),this.keys=["private_enc","public_enc","private_sign","public_sign","derived"],this.keyLabels=["eSK","ePK","sSK","sPK","aes"],this.storeKey=function(t,e){return function(t,e,n=u()){return n("readwrite",(n=>(n.put(e,t),s(n.transaction))))}(t,e,n.store)},this.storeKeys=function(t,e,r,i,o){return function(t,e=u()){return e("readwrite",(e=>(t.forEach((t=>e.put(t[1],t[0]))),s(e.transaction))))}([["private_enc",t],["public_enc",e],["private_sign",r],["public_sign",i],["derived",o]],n.store)},this.getKey=function(t){return f(t,n.store)},this.getSignKey=function(t){return f(t,n.store)},this.getKeys=function(){return function(t,e=u()){return e("readonly",(e=>Promise.all(t.map((t=>s(e.get(t)))))))}(n.keys,n.store).then((function(t){return t.reduce((function(t,e,i){var o;return r(r({},t),((o={})[n.keyLabels[i]]=e,o))}),{})}))},this.clear=function(){return function(t=u()){return t("readwrite",(t=>(t.clear(),s(t.transaction))))}(n.store)},this.store=a(t,e)},l="object"==typeof window;function y(t){return(new TextEncoder).encode(t)}function h(t){return(new TextDecoder).decode(t)}function p(t){return l?Uint8Array.from(window.atob(t),(function(t){return t.charCodeAt(0)})):Buffer.from(t,"base64")}function v(t){if(l){for(var e=new Uint8Array(t),n="",r=0;r<e.length;r++)n+=String.fromCharCode(e[r]);return window.btoa(n)}return Buffer.from(t).toString("base64")}function w(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=new Uint8Array(t.reduce((function(t,e){return t+e.byteLength}),0)),r=0;return t.forEach((function(t){n.set(t instanceof ArrayBuffer?new Uint8Array(t):t,r),r+=t.byteLength})),n.buffer}function b(t){return[t,t<<8,t<<16,t<<24].map((function(t){return t>>>24}))}function m(t){return new Uint8Array(t).reduce((function(t,e,n){return t+e*Math.pow(2,24-8*n)}),0)}function g(t){return[t<<16,t<<24].map((function(t){return t>>>24}))}function A(t){return new Uint8Array(t).reduce((function(t,e,n){return t+e*Math.pow(2,8-8*n)}),0)}function S(t){var e="",n="0123456789ABCDEF";return(t instanceof ArrayBuffer?new Uint8Array(t):t).forEach((function(t){e+=n[t>>4]+n[15&t]})),e}function E(t){for(var e=[],n=0;n<t.length;n+=2)e.push(parseInt(t.substr(n,2),16));return new Uint8Array(e)}function K(t,e){try{return t()}catch(t){throw e}}function P(t,e){return i(this,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,t()];case 1:return[2,n.sent()];case 2:throw n.sent(),e;case 3:return[2]}}))}))}var B=Object.freeze({__proto__:null,str2bin:y,bin2str:h,b64str2bin:p,bin2b64str:v,concat:w,to4Bytes:b,from4Bytes:m,to2Bytes:g,from2Bytes:A,bin2Hex:S,hex2bin:E,mapError:K,mapErrorAsync:P}),U=function(t,e,n){var s=this;this.apiUrl=void 0,this.protocolVersion=void 0,this.token=void 0,this.registerUser=function(t,e,n,r,a,c,u){return i(s,void 0,void 0,(function(){var i;return o(this,(function(o){switch(o.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/users",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify({publicEncryptionKey:v(t),publicSigningKey:v(e),encryptedPrivateEncryptionKey:v(n),encryptedPrivateSigningKey:v(r),keyDerivationSalt:v(a),signedJwt:v(c),signedPublicEncryptionKey:v(u)})})];case 1:return i=o.sent(),[4,k(i)((function(t){}))];case 2:return[2,o.sent()]}}))}))},this.getUserData=function(){return i(s,void 0,void 0,(function(){function t(t){return{type:"UserFound",userData:{enc_PK:t.publicEncryptionKey,e_enc_SK:t.encryptedPrivateEncryptionKey,sign_PK:t.publicSigningKey,e_sign_SK:t.encryptedPrivateSigningKey,salt:t.keyDerivationSalt}}}var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/keys/me",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}})];case 1:return e=n.sent(),[4,k(e,{type:"UserNotFound"})(t)];case 2:return[2,n.sent()]}}))}))},this.getUsersPublicKey=function(t){return i(s,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/keys/"+t,{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}})];case 1:return e=n.sent(),[4,k(e)((function(t){return r({},t)}))];case 2:return[2,n.sent()]}}))}))},this.getPublicKeys=function(t){return i(s,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/keys",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify({userIds:t})})];case 1:return e=n.sent(),[4,k(e)((function(t){return t}))];case 2:return[2,n.sent()]}}))}))},this.getGroupPublicKeys=function(t){return i(s,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/keys",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify({groupId:t})})];case 1:return e=n.sent(),[4,k(e)((function(t){return t}))];case 2:return[2,n.sent()]}}))}))},this.postEncryptedKeys=function(t){return i(s,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/documents",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify(t)})];case 1:return e=n.sent(),[4,k(e)((function(t){return t}))];case 2:return[2,n.sent()]}}))}))},this.getDataKey=function(t){return i(s,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/documents/keys/"+t,{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}})];case 1:return e=n.sent(),[4,k(e)((function(t){return t}))];case 2:return[2,n.sent()]}}))}))},this.getAllDataKeys=function(){return i(s,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/documents/keys",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token}})];case 1:return t=e.sent(),[4,k(t)((function(t){return t}))];case 2:return[2,e.sent()]}}))}))},this.getDataKeys=function(t){return i(s,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/documents/keys",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify({data_ids:t})})];case 1:return e=n.sent(),[4,k(e)((function(t){return t}))];case 2:return[2,n.sent()]}}))}))},this.updateUser=function(t,e,n){return i(s,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/keys/me",{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify({encryptedPrivateEncryptionKey:v(t),encryptedPrivateSigningKey:v(e),keyDerivationSalt:v(n)})})];case 1:return r=i.sent(),[4,k(r)((function(t){}))];case 2:return[2,i.sent()]}}))}))},this.giveAccess=function(t,e){return i(s,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,fetch(this.apiUrl+"/api/v"+this.protocolVersion+"/documents/keys/user/"+t,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.token},body:JSON.stringify(e)})];case 1:return n=r.sent(),[4,k(n)((function(t){}))];case 2:return[2,r.sent()]}}))}))},this.updateToken=function(t){return s.token=t},this.clearToken=function(){return s.token=void 0},this.token=t,this.apiUrl=e,this.protocolVersion=n},k=function(t,e){return function(n){return i(void 0,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:switch(t.status){case 200:return[3,1];case 401:return[3,3];case 400:return[3,4]}return[3,5];case 1:return[4,t.json()];case 2:return r=i.sent(),[2,{type:"Success",data:n(r)}];case 3:return[2,{type:"AuthenticationNeeded"}];case 4:return null!=e?[2,{type:"Success",data:e}]:[2,{type:"Failed"}];case 5:return[2,{type:"Failed"}]}}))}))}},O=function(t){function e(){var e=this.constructor,n=t.call(this,"Authentication to blindnet failed. Please generate a valid token.")||this;return n.code="blindnet.authentication",n.name="AuthenticationError",Object.setPrototypeOf(n,e.prototype),n}return n(e,t),e}(Error),x=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code="blindnet.user_not_initialized",r.name="UserNotInitializedError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),_=function(t){function e(){var e=this.constructor,n=t.call(this,"Wrong secret provided.")||this;return n.code="blindnet.secret",n.name="SecretError",Object.setPrototypeOf(n,e.prototype),n}return n(e,t),e}(Error),j=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code="blindnet.data_format",r.name="BadFormatError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),T=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code="blindnet.encryption",r.name="EncryptionError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),R=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code="blindnet.service",r.name="BlindnetServiceError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),N=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code="blindnet.not_encryptable",r.name="NotEncryptabeError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),C=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code=7,r.name="NoAccessError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),I=function(t){function e(e){var n=this.constructor,r=t.call(this,e)||this;return r.code=8,r.name="UserNotFoundError",Object.setPrototypeOf(r,n.prototype),r}return n(e,t),e}(Error),D=Object.freeze({__proto__:null,AuthenticationError:O,UserNotInitializedError:x,SecretError:_,EncryptionError:T,BlindnetServiceError:R,NotEncryptabeError:N,NoAccessError:C,UserNotFoundError:I,BadFormatError:j});var z,F={},V=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){
/*! noble-ed25519 - MIT License (c) Paul Miller (paulmillr.com) */
Object.defineProperty(e,"__esModule",{value:!0}),e.utils=e.verify=e.sign=e.getPublicKey=e.SignResult=e.Signature=e.Point=e.ExtendedPoint=e.CURVE=void 0;const n={a:-1n,d:37095705934669439343138083508754565189542113879843219016388785533085940283555n,P:2n**255n-19n,n:2n**252n+27742317777372353535851937790883648493n,h:8n,Gx:15112221349535400772501151409588531511454012693041857206046113283949847762202n,Gy:46316835694926478169428394003475163141307993866256225615783033603165251855960n};e.CURVE=n;const r=32,i=19681161376707505956807079304988542015446066515923890162744021073123829784752n,o=25063068953384623474111414158702152701244531502492656460079210482610430750235n,s=54469307008909316920995813868745141605393597292927456921205312896311721017578n,a=1159843021668779879193775521855586647937357759715417654439879720876111806838n,c=40440834346308536858101042469323190826248399146238708352240133220865137265952n;class u{constructor(t,e,n,r){this.x=t,this.y=e,this.z=n,this.t=r}static fromAffine(t){if(!(t instanceof d))throw new TypeError("ExtendedPoint#fromAffine: expected Point");return t.equals(d.ZERO)?u.ZERO:new u(t.x,t.y,1n,A(t.x*t.y))}static toAffineBatch(t){const e=function(t,e=n.P){const r=t.length,i=new Array(r);let o=1n;for(let n=0;n<r;n++)0n!==t[n]&&(i[n]=o,o=A(o*t[n],e));o=S(o,e);for(let n=r-1;n>=0;n--){if(0n===t[n])continue;let r=A(o*t[n],e);t[n]=A(o*i[n],e),o=r}return t}(t.map((t=>t.z)));return t.map(((t,n)=>t.toAffine(e[n])))}static normalizeZ(t){return this.toAffineBatch(t).map(this.fromAffine)}static fromRistrettoHash(t){const e=g(t.slice(0,r)),n=this.calcElligatorRistrettoMap(e),i=g(t.slice(r,64)),o=this.calcElligatorRistrettoMap(i);return n.add(o)}static calcElligatorRistrettoMap(t){const{d:e}=n,r=A(i*t*t),s=A((r+1n)*a);let f=-1n;const d=A((f-e*r)*A(r+e));let{isValid:l,value:y}=K(s,d),h=A(y*t);w(h)||(h=A(-h)),l||(y=h),l||(f=r);const p=A(f*(r-1n)*c-d),v=y*y,b=A((y+y)*d),m=A(p*o),g=A(1n-v),S=A(1n+v);return new u(A(b*S),A(g*m),A(m*S),A(b*g))}static fromRistrettoBytes(t){const{a:e,d:i}=n,o="ExtendedPoint.fromRistrettoBytes: Cannot convert bytes to Ristretto Point",s=g(t);if(!function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}(v(s,r),t)||w(s))throw new Error(o);const a=A(s*s),c=A(1n+e*a),f=A(1n-e*a),d=A(c*c),l=A(f*f),y=A(e*i*d-l),{isValid:h,value:p}=P(A(y*l)),b=A(p*f),m=A(p*b*y);let S=A((s+s)*b);w(S)&&(S=A(-S));const E=A(c*m),K=A(S*E);if(!h||w(K)||0n===E)throw new Error(o);return new u(S,E,1n,K)}toRistrettoBytes(){let{x:t,y:e,z:n,t:o}=this;const a=A((n+e)*(n-e)),c=A(t*e),{value:u}=P(A(a*c**2n)),f=A(u*a),d=A(u*c),l=A(f*d*o);let y;w(o*l)?([t,e]=[A(e*i),A(t*i)],y=A(f*s)):y=d,w(t*l)&&(e=A(-e));let h=A((n-e)*y);return w(h)&&(h=A(-h)),v(h,r)}equals(t){const e=t,[n,r,i,o]=[this.t,e.t,this.z,e.z];return A(n*o)===A(r*i)}negate(){return new u(A(-this.x),this.y,this.z,A(-this.t))}double(){const t=this.x,e=this.y,r=this.z,{a:i}=n,o=A(t**2n),s=A(e**2n),a=A(2n*r**2n),c=A(i*o),f=A((t+e)**2n-o-s),d=A(c+s),l=A(d-a),y=A(c-s),h=A(f*l),p=A(d*y),v=A(f*y),w=A(l*d);return new u(h,p,w,v)}add(t){const e=this.x,n=this.y,r=this.z,i=this.t,o=t.x,s=t.y,a=t.z,c=t.t,f=A((n-e)*(s+o)),d=A((n+e)*(s-o)),l=A(d-f);if(0n===l)return this.double();const y=A(2n*r*c),h=A(2n*i*a),p=A(h+y),v=A(d+f),w=A(h-y),b=A(p*l),m=A(v*w),g=A(p*w),S=A(l*v);return new u(b,m,S,g)}subtract(t){return this.add(t.negate())}multiplyUnsafe(t){if(!b(t))throw new TypeError("Point#multiply: expected number or bigint");let e=A(BigInt(t),n.n);if(1n===e)return this;let r=u.ZERO,i=this;for(;e>0n;)1n&e&&(r=r.add(i)),i=i.double(),e>>=1n;return r}precomputeWindow(t){const e=256/t+1;let n=[],r=this,i=r;for(let o=0;o<e;o++){i=r,n.push(i);for(let e=1;e<2**(t-1);e++)i=i.add(r),n.push(i);r=i.double()}return n}wNAF(t,e){!e&&this.equals(u.BASE)&&(e=d.BASE);const n=e&&e._WINDOW_SIZE||1;if(256%n)throw new Error("Point#wNAF: Invalid precomputation window, must be power of 2");let r=e&&f.get(e);r||(r=this.precomputeWindow(n),e&&1!==n&&(r=u.normalizeZ(r),f.set(e,r)));let i=u.ZERO,o=u.ZERO;const s=256/n+1,a=2**(n-1),c=BigInt(2**n-1),l=2**n,y=BigInt(n);for(let e=0;e<s;e++){const n=e*a;let s=Number(t&c);if(t>>=y,s>a&&(s-=l,t+=1n),0===s)o=o.add(e%2?r[n].negate():r[n]);else{const t=r[n+Math.abs(s)-1];i=i.add(s<0?t.negate():t)}}return[i,o]}multiply(t,e){if(!b(t))throw new TypeError("Point#multiply: expected number or bigint");const r=A(BigInt(t),n.n);return u.normalizeZ(this.wNAF(r,e))[0]}toAffine(t=S(this.z)){const e=A(this.x*t),n=A(this.y*t);return new d(e,n)}}e.ExtendedPoint=u,u.BASE=new u(n.Gx,n.Gy,1n,A(n.Gx*n.Gy)),u.ZERO=new u(0n,1n,1n,0n);const f=new WeakMap;class d{constructor(t,e){this.x=t,this.y=e}_setWindowSize(t){this._WINDOW_SIZE=t,f.delete(this)}static fromHex(t){const{d:e,P:r}=n,i=t instanceof Uint8Array?t:h(t);if(32!==i.length)throw new Error("Point.fromHex: expected 32 bytes");const o=i[31],s=-129&o,a=0!=(128&o),c=m(Uint8Array.from(Array.from(i.slice(0,31)).concat(s)));if(c>=r)throw new Error("Point.fromHex expects hex <= Fp");const u=A(c*c),f=A(u-1n),l=A(e*u+1n);let{isValid:y,value:p}=K(f,l);if(!y)throw new Error("Point.fromHex: invalid y coordinate");return a!==(1n===(1n&p))&&(p=A(-p)),new d(p,c)}static async fromPrivateKey(t){const n=await e.utils.sha512(O(t));return d.BASE.multiply(U(n))}toRawBytes(){const t=p(this.y),e=new Uint8Array(r);for(let n=t.length-2,i=0;i<r&&n>=0;n-=2,i++)e[i]=Number.parseInt(t[n]+t[n+1],16);const n=1n&this.x?128:0;return e[31]|=n,e}toHex(){return y(this.toRawBytes())}toX25519(){return A((1n+this.y)*S(1n-this.y))}equals(t){return this.x===t.x&&this.y===t.y}negate(){return new d(A(-this.x),this.y)}add(t){return u.fromAffine(this).add(u.fromAffine(t)).toAffine()}subtract(t){return this.add(t.negate())}multiply(t){return u.fromAffine(this).multiply(t,this).toAffine()}}e.Point=d,d.BASE=new d(n.Gx,n.Gy),d.ZERO=new d(0n,1n);class l{constructor(t,e){this.r=t,this.s=e}static fromHex(t){t=k(t);const e=d.fromHex(t.slice(0,32)),r=m(t.slice(32));if(!(0<(i=r)&&i<n.n))throw new Error("Signature.fromHex expects s <= CURVE.n");var i;return new l(e,r)}toRawBytes(){const t=h(p(this.s)).reverse(),e=new Uint8Array(r);e.set(t);const n=new Uint8Array(64);return n.set(this.r.toRawBytes()),n.set(e,32),n}toHex(){return y(this.toRawBytes())}}function y(t){let e="";for(let n=0;n<t.length;n++)e+=t[n].toString(16).padStart(2,"0");return e}function h(t){if("string"!=typeof t)throw new TypeError("hexToBytes: expected string, got "+typeof t);if(t.length%2)throw new Error("hexToBytes: received invalid unpadded hex");const e=new Uint8Array(t.length/2);for(let n=0;n<e.length;n++){const r=2*n;e[n]=Number.parseInt(t.slice(r,r+2),16)}return e}function p(t){const e=t.toString(16);return 1&e.length?`0${e}`:e}function v(t,e=32){return h(p(t).padStart(2*e,"0")).reverse()}function w(t){return 1n===(1n&A(t))}function b(t){return"bigint"==typeof t&&t>0n||!!("number"==typeof t&&t>0&&Number.isSafeInteger(t))}function m(t){let e=0n;for(let n=0;n<t.length;n++)e+=BigInt(t[n])<<8n*BigInt(n);return e}function g(t){return A(m(t)&2n**255n-1n)}function A(t,e=n.P){const r=t%e;return r>=0n?r:e+r}function S(t,e=n.P){if(0n===t||e<=0n)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let r=A(t,e),i=e,[o,s,a,c]=[0n,1n,1n,0n];for(;0n!==r;){const t=i/r,e=i%r,n=o-a*t,u=s-c*t;[i,r]=[r,e],[o,s]=[a,c],[a,c]=[n,u]}if(1n!==i)throw new Error("invert: does not exist");return A(o,e)}function E(t,e){const{P:r}=n;let i=t;for(;e-- >0n;)i*=i,i%=r;return i}function K(t,e){const r=A(e*e*e),o=A(r*r*e);let s=A(t*r*function(t){const{P:e}=n,r=t*t%e*t%e,i=E(r,2n)*r%e,o=E(i,1n)*t%e,s=E(o,5n)*o%e,a=E(s,10n)*s%e,c=E(a,20n)*a%e,u=E(c,40n)*c%e,f=E(u,80n)*u%e,d=E(f,80n)*u%e,l=E(d,10n)*s%e;return E(l,2n)*t%e}(t*o));const a=A(e*s*s),c=s,u=A(s*i),f=a===t,d=a===A(-t),l=a===A(-t*i);return f&&(s=c),(d||l)&&(s=u),w(s)&&(s=A(-s)),{isValid:f||d,value:s}}function P(t){return K(1n,t)}async function B(...t){const r=function(...t){if(1===t.length)return t[0];const e=t.reduce(((t,e)=>t+e.length),0),n=new Uint8Array(e);for(let e=0,r=0;e<t.length;e++){const i=t[e];n.set(i,r),r+=i.length}return n}(...t);return A(m(await e.utils.sha512(r)),n.n)}function U(t){const e=t.slice(0,r);return e[0]&=248,e[31]&=127,e[31]|=64,A(m(e),n.n)}function k(t){return t instanceof Uint8Array?t:h(t)}function O(t){let e;if("bigint"==typeof t||"number"==typeof t&&Number.isSafeInteger(t)){if(e=BigInt(t),e<0n||e>2n**256n)throw new Error("Expected 32 bytes of private key");t=e.toString(16).padStart(64,"0")}if("string"==typeof t){if(64!==t.length)throw new Error("Expected 32 bytes of private key");return h(t)}if(t instanceof Uint8Array){if(32!==t.length)throw new Error("Expected 32 bytes of private key");return t}throw new TypeError("Expected valid private key")}e.Signature=l,e.SignResult=l,e.getPublicKey=async function(t){const e=await d.fromPrivateKey(t);return"string"==typeof t?e.toHex():e.toRawBytes()},e.sign=async function(t,i){const o=await e.utils.sha512(O(i)),s=U(o),a=d.BASE.multiply(s),c=k(t),u=await B((f=o,f.slice(r)),c);var f;const y=d.BASE.multiply(u),h=A(u+await B(y.toRawBytes(),a.toRawBytes(),c)*s,n.n),p=new l(y,h);return"string"==typeof t?p.toHex():p.toRawBytes()},e.verify=async function(t,e,n){e=k(e),n instanceof d||(n=d.fromHex(n)),t instanceof l||(t=l.fromHex(t));const r=await B(t.r.toRawBytes(),n.toRawBytes(),e),i=u.fromAffine(n).multiplyUnsafe(r),o=u.BASE.multiply(t.s);return u.fromAffine(t.r).add(i).subtract(o).multiplyUnsafe(8n).equals(u.ZERO)},d.BASE._setWindowSize(8),e.utils={TORSION_SUBGROUP:["0100000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a","0000000000000000000000000000000000000000000000000000000000000080","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05","ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85","0000000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa"],randomPrivateKey:(t=32)=>{if("object"==typeof self&&"crypto"in self)return self.crypto.getRandomValues(new Uint8Array(t));if("object"==typeof process&&"node"in process.versions){const{randomBytes:e}=F;return new Uint8Array(e(t).buffer)}throw new Error("The environment doesn't have randomBytes function")},sha512:async t=>{if("object"==typeof self&&"crypto"in self){const e=await self.crypto.subtle.digest("SHA-512",t.buffer);return new Uint8Array(e)}if("object"==typeof process&&"node"in process.versions){const{createHash:e}=F,n=e("sha512");return n.update(t),Uint8Array.from(n.digest())}throw new Error("The environment doesn't have sha512 function")},precompute(t=8,e=d.BASE){const n=e.equals(d.BASE)?e:new d(e.x,e.y);return n._setWindowSize(t),n.multiply(1n),n}}}));(z=V)&&z.__esModule&&Object.prototype.hasOwnProperty.call(z,"default")&&z.default;var G=V.utils;V.verify;var H=V.sign,J=V.getPublicKey;function M(t,e,n){return void 0===n&&(n=!1),i(this,void 0,void 0,(function(){var r,i;return o(this,(function(o){switch(o.label){case 0:return r="string"==typeof e?p(e):e,[4,crypto.subtle.importKey("raw",y(t),"PBKDF2",!1,["deriveKey"])];case 1:return i=o.sent(),[4,crypto.subtle.deriveKey({name:"PBKDF2",salt:r,iterations:1e5,hash:"SHA-256"},i,{name:"AES-GCM",length:256},n,["decrypt","encrypt","wrapKey","unwrapKey"])];case 2:return[2,o.sent()]}}))}))}function Z(t){return i(this,void 0,void 0,(function(){var e,n,r,i;return o(this,(function(o){switch(o.label){case 0:return e=0===t.length||null==t?"seed":t,[4,crypto.subtle.importKey("raw",y(e),"PBKDF2",!1,["deriveBits"])];case 1:return n=o.sent(),r=new Uint8Array([241,211,153,239,17,34,5,112,167,218,57,131,99,29,243,84]),[4,crypto.subtle.deriveBits({name:"PBKDF2",salt:r,iterations:64206,hash:"SHA-256"},n,512)];case 2:return i=o.sent(),[2,{secret1:new Uint8Array(i,0,32),secret2:new Uint8Array(i,32,32)}]}}))}))}function W(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])];case 1:return[2,t.sent()]}}))}))}function L(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["encrypt","decrypt","wrapKey","unwrapKey"])];case 1:return[2,t.sent()]}}))}))}function q(){return i(this,void 0,void 0,(function(){var t,e;return o(this,(function(n){switch(n.label){case 0:return t=G.randomPrivateKey(),[4,J(t)];case 1:return e=n.sent(),[2,{privateKey:t,publicKey:e}]}}))}))}function $(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){return n="string"==typeof t?y(t):t,[2,H(new Uint8Array(n),e)]}))}))}function X(t){return crypto.subtle.importKey("jwk",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["wrapKey","encrypt"])}function Y(t,e,n){return i(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.wrapKey("jwk",t,e,{name:"AES-GCM",iv:n})];case 1:return[2,r.sent()]}}))}))}function Q(t,e){return crypto.subtle.wrapKey("jwk",t,e,{name:"RSA-OAEP"})}function tt(t,e){return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return n="string"==typeof t?p(t):t,[4,crypto.subtle.unwrapKey("jwk",n,e,{name:"RSA-OAEP"},{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])];case 1:return[2,r.sent()]}}))}))}function et(t,e,n){return i(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,n)];case 1:return[2,r.sent()]}}))}))}function nt(t,e,n){return i(this,void 0,void 0,(function(){return o(this,(function(r){return[2,crypto.subtle.decrypt({name:"AES-GCM",iv:e},t,n)]}))}))}function rt(t,e,n){if(void 0===n&&(n=function(t){return!0}),"AuthenticationNeeded"===t.type)throw new O;if("Failed"===t.type)throw new R(e);if(n(t.data))return t.data;throw new R("Data returned from server not valid")}V.SignResult,V.Signature,V.Point,V.ExtendedPoint,V.CURVE;var it=function(){function t(t,e){this.data=t,this.service=e}return t.prototype.withMetadata=function(t){return this.metadata=t,this},t.prototype.forUser=function(t){return this.userIds=[t],this},t.prototype.forUsers=function(t){return this.userIds=t,this},t.prototype.forGroup=function(t){return this.groupId=t,this},t.prototype.encrypt=function(){return i(this,void 0,void 0,(function(){var t,e,n,r,s,a,c,u,f,d,l,m,A,S,E,B,U,k,O=this;return o(this,(function(x){switch(x.label){case 0:try{t=this.data,e=null==this.metadata?{}:this.metadata}catch(t){throw new j("Data in bad format. Expected an object { data, metadata }")}if(null==t)throw new j("Data can't be undefined or null");if("object"!=typeof e)throw new j("Metadata has to be an object");return"string"!=typeof t?[3,1]:(n=y(t),r={type:"String"},[3,4]);case 1:return t instanceof File?[4,t.arrayBuffer()]:[3,3];case 2:return n=x.sent(),r={type:"File",name:t.name},[3,4];case 3:if(t instanceof ArrayBuffer||t instanceof Uint8Array)n=t,r={type:"Binary"};else{if("object"!=typeof t)throw new j("Encryption of provided data format is not supported");n=K((function(){return y(JSON.stringify(t))}),new j("Data in bad format")),r={type:"Json"}}x.label=4;case 4:return s=y(JSON.stringify(r)),a=g(s.byteLength),c=y(JSON.stringify(e)),u=b(c.byteLength),null==this.userIds||"[object Array]"!==Object.prototype.toString.call(this.userIds)?[3,6]:[4,this.service.getPublicKeys(this.userIds)];case 5:return f=x.sent(),[3,9];case 6:return null==this.groupId||"string"!=typeof this.groupId?[3,8]:[4,this.service.getGroupPublicKeys(this.groupId)];case 7:return f=x.sent(),[3,9];case 8:throw new N("You must specify a list of users or a group to encrypt the data for");case 9:if(0==(d=rt(f,"Fetching public keys failed")).length)throw new N("Selected users not found");return l=w(new Uint8Array(a),new Uint8Array(u),s,c,n),[4,P((function(){return W()}),new T("Could not generate key"))];case 10:return m=x.sent(),A=crypto.getRandomValues(new Uint8Array(12)),[4,P((function(){return et(m,A,l)}),new T("Could not encrypt data"))];case 11:return S=x.sent(),[4,Promise.all(d.map((function(t){return i(O,void 0,void 0,(function(){var e,n;return o(this,(function(r){switch(r.label){case 0:return[4,P((function(){return X(JSON.parse(h(p(t.publicEncryptionKey))))}),new T("Public key in wrong format"))];case 1:return e=r.sent(),[4,P((function(){return Q(m,e)}),new T("Could not encrypt data key"))];case 2:return n=r.sent(),[2,{userID:t.userID,encryptedSymmetricKey:v(n)}]}}))}))})))];case 12:return E=x.sent(),[4,this.service.postEncryptedKeys(E)];case 13:return B=x.sent(),U=rt(B,"Could not upload the encrypted public keys"),k=w(y(U),A.buffer,S),[2,{dataId:U,encryptedData:k}]}}))}))},t}(),ot=function(){function t(t,e){this.service=t,this.keyStore=e}return t.testBrowser=function(){return i(this,void 0,void 0,(function(){var t,e,n,r,i,s,a;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,10,,11]),(t=W())instanceof Promise?[4,t]:[2,!1];case 1:return e=o.sent(),[4,L()];case 2:return n=o.sent(),[4,q()];case 3:return r=o.sent(),[4,(i=new d("blindnet_test")).clear()];case 4:return o.sent(),[4,i.storeKey("test_key",e)];case 5:return o.sent(),[4,i.storeKeys(n.privateKey,n.publicKey,r.privateKey,r.publicKey,e)];case 6:return o.sent(),[4,i.getKey("test_key")];case 7:return o.sent()instanceof CryptoKey?[4,i.getKeys()]:[2,!1];case 8:return(s=o.sent()).eSK instanceof CryptoKey&&s.ePK instanceof CryptoKey&&s.sSK instanceof Uint8Array&&s.sPK instanceof Uint8Array&&s.aes instanceof CryptoKey?[4,i.clear()]:[2,!1];case 9:return o.sent(),[3,11];case 10:return a=o.sent(),console.error(a),[2,!1];case 11:return[2,!0]}}))}))},t.initCustomKeyStore=function(e,n,r){return void 0===r&&(r=t.apiUrl),new t(new U(e,r,t.protocolVersion),n)},t.init=function(e,n){return void 0===n&&(n=t.apiUrl),new t(new U(e,n,t.protocolVersion),new d)},t.disconnect=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,(new d).clear()];case 1:return t.sent(),[2]}}))}))},t.prototype.disconnect=function(){return i(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.service.clearToken(),[4,this.keyStore.clear()];case 1:return t.sent(),[2]}}))}))},t.prototype.refreshToken=function(t){this.service.updateToken(t)},t.deriveSecrets=function(t){return i(this,void 0,void 0,(function(){var e,n,r,i,s;return o(this,(function(o){switch(o.label){case 0:return[4,Z(t)];case 1:return e=o.sent(),n=e.secret1,r=e.secret2,i=v(n),s=v(r),[2,{blindnetSecret:i,appSecret:s}]}}))}))},t.prototype.getKeys=function(){return i(this,void 0,void 0,(function(){var t,e=this;return o(this,(function(n){switch(n.label){case 0:return[4,P((function(){return e.keyStore.getKeys()}),new x("Keys not initialized"))];case 1:if(t=n.sent(),0===Object.values(t).length||Object.values(t).some((function(t){return null==t})))throw new x("Keys not initialized");return[2,t]}}))}))},t.prototype.connect=function(t){return i(this,void 0,void 0,(function(){var e,n,r,s,a,c,u,f,d,l,y,v,b,m,g,A,S,E,K,U,k,O,x,j,T;return o(this,(function(R){switch(R.label){case 0:return[4,this.keyStore.clear()];case 1:return R.sent(),[4,this.service.getUserData()];case 2:switch(e=R.sent(),n=rt(e,"Fetching user data failed"),n.type){case"UserNotFound":return[3,3];case"UserFound":return[3,14]}return[3,20];case 3:return[4,L()];case 4:return r=R.sent(),j=r.privateKey,O=r.publicKey,[4,q()];case 5:return s=R.sent(),T=s.privateKey,a=s.publicKey,f=(u=B).str2bin,l=(d=JSON).stringify,[4,(N=O,crypto.subtle.exportKey("jwk",N))];case 6:return c=f.apply(u,[l.apply(d,[R.sent()])]),[4,$(this.service.token,T)];case 7:return y=R.sent(),[4,$(c,T)];case 8:return v=R.sent(),k=crypto.getRandomValues(new Uint8Array(16)),[4,M(t,k)];case 9:return b=R.sent(),[4,Y(j,b,new Uint8Array(12))];case 10:return m=R.sent(),[4,et(b,new Uint8Array(12).map((function(t){return 1})),w(T,a))];case 11:return g=R.sent(),[4,this.service.registerUser(c,a,m,g,k,y,v)];case 12:return rt(R.sent(),"User could not be registered"),[4,this.keyStore.storeKeys(j,O,T,a,b)];case 13:return R.sent(),[2,void 0];case 14:return A=n.userData,S=A.enc_PK,E=A.e_enc_SK,K=A.sign_PK,U=A.e_sign_SK,k=A.salt,[4,X(JSON.parse(h(p(S))))];case 15:return O=R.sent(),[4,M(t,k)];case 16:return x=R.sent(),[4,P((function(){return function(t,e,n){return i(this,void 0,void 0,(function(){var r;return o(this,(function(i){return r="string"==typeof t?p(t):t,[2,crypto.subtle.unwrapKey("jwk",r,e,{name:"AES-GCM",iv:n},{name:"RSA-OAEP",hash:"SHA-256"},!0,["decrypt","unwrapKey"])]}))}))}(E,x,new Uint8Array(12))}),new _)];case 17:return j=R.sent(),[4,P((function(){return nt(x,new Uint8Array(12).map((function(t){return 1})),p(U))}),new _)];case 18:return T=R.sent(),[4,this.keyStore.storeKeys(j,O,new Uint8Array(T).slice(0,32),p(K),x)];case 19:return R.sent(),[2,void 0];case 20:return[2]}var N}))}))},t.prototype.capture=function(t){return new it(t,this.service)},t.prototype.decrypt=function(t){return i(this,void 0,void 0,(function(){var e,n,r,i,s,a,c,u,f,d,l,y,v,w;return o(this,(function(o){switch(o.label){case 0:return[4,this.getKeys()];case 1:if(e=o.sent().eSK,36!==(n=K((function(){return h(t.slice(0,36))}),new j("Bad data provided"))).length)throw new j("Bad data provided");return[4,this.service.getDataKey(n)];case 2:return r=o.sent(),i=rt(r,"Fetching data key failed for data with id "+n),[4,P((function(){return tt(p(i),e)}),new T("Encrypted data key for data with id "+n+" could not be decrypted"))];case 3:return s=o.sent(),[4,P((function(){return nt(s,t.slice(36,48),t.slice(48))}),new T("Encrypted data with id "+n+" could not be decrypted"))];case 4:a=o.sent();try{d=A(Array.from(new Uint8Array(a.slice(0,2)))),l=a.slice(6,6+d),f=JSON.parse(h(l)),y=m(Array.from(new Uint8Array(a.slice(2,6)))),v=a.slice(6+d,6+d+y),u=JSON.parse(h(v)),c=a.slice(6+d+y)}catch(t){throw new j("Bad data provided")}switch(f.type){case"String":return[2,{data:K((function(){return h(c)}),new j("Bad data provided")),metadata:u,dataType:f}];case"File":return w=f.name,[2,{data:K((function(){return new File([c],w)}),new j("Bad data provided")),metadata:u,dataType:f}];case"Binary":return[2,{data:c,metadata:u,dataType:f}];case"Json":return[2,{data:K((function(){return JSON.parse(h(c))}),new j("Bad data provided")),metadata:u,dataType:f}]}return[2]}}))}))},t.prototype.decryptMany=function(t){return i(this,void 0,void 0,(function(){var e,n,r,s,a=this;return o(this,(function(c){switch(c.label){case 0:return[4,this.getKeys()];case 1:return e=c.sent().eSK,n=t.map((function(t){var e=K((function(){return h(t.slice(0,36))}),new j("Bad data provided"));if(36!==e.length)throw new j("Bad data provided");return e})),[4,this.service.getDataKeys(n)];case 2:return r=c.sent(),s=rt(r,"Fetching data keys failed for ids "+n,(function(t){return n.every((function(e){return t.find((function(t){return t.documentID===e}))}))})),[2,Promise.all(t.map((function(t,r){return i(a,void 0,void 0,(function(){var i,a,c,u,f,d,l,y,v,w,b;return o(this,(function(o){switch(o.label){case 0:return i=n[r],[4,P((function(){return tt(p(s.find((function(t){return t.documentID===i})).encryptedSymmetricKey),e)}),new T("Encrypted data key for data with id "+i+" could not be decrypted"))];case 1:return a=o.sent(),[4,P((function(){return nt(a,t.slice(36,48),t.slice(48))}),new T("Encrypted data with id "+i+" could not be decrypted"))];case 2:c=o.sent();try{l=A(Array.from(new Uint8Array(c.slice(0,2)))),y=c.slice(6,6+l),d=JSON.parse(h(y)),v=m(Array.from(new Uint8Array(c.slice(2,6)))),w=c.slice(6+l,6+l+v),f=JSON.parse(h(w)),u=c.slice(6+l+v)}catch(t){throw new j("Bad data provided for id "+i)}switch(d.type){case"String":return[2,{data:K((function(){return h(u)}),new j("Bad data provided")),metadata:f,dataType:d}];case"File":return b=d.name,[2,{data:K((function(){return new File([u],b)}),new j("Bad data provided")),metadata:f,dataType:d}];case"Binary":return[2,{data:u,metadata:f,dataType:d}];case"Json":return[2,{data:K((function(){return JSON.parse(h(u))}),new j("Bad data provided")),metadata:f,dataType:d}]}return[2]}}))}))})))]}}))}))},t.prototype.changeSecret=function(t,e){return i(this,void 0,void 0,(function(){var e,n,r,i,s,a,c;return o(this,(function(o){switch(o.label){case 0:return[4,this.getKeys()];case 1:return e=o.sent(),n=e.eSK,r=e.sSK,i=crypto.getRandomValues(new Uint8Array(16)),[4,M(t,i)];case 2:return s=o.sent(),[4,Y(n,s,new Uint8Array(12))];case 3:return a=o.sent(),[4,crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(12).map((function(t){return 1}))},s,r)];case 4:return c=o.sent(),[4,this.service.updateUser(a,c,i)];case 5:return rt(o.sent(),"Could not upload the new keys"),[4,this.keyStore.storeKey("derived",s)];case 6:return o.sent(),[2]}}))}))},t.prototype.giveAccess=function(t){return i(this,void 0,void 0,(function(){var e,n,r,s,a,c,u,f=this;return o(this,(function(d){switch(d.label){case 0:return[4,this.getKeys()];case 1:return e=d.sent().eSK,[4,this.service.getUsersPublicKey(t)];case 2:return n=d.sent(),r=rt(n,"Fetching the public key of a user "+t+" failed"),[4,this.service.getAllDataKeys()];case 3:return s=d.sent(),a=rt(s,"Fetching the encrypted data keys failed"),[4,P((function(){return X(JSON.parse(h(p(r.publicEncryptionKey))))}),new T("Public key in wrong format"))];case 4:return c=d.sent(),[4,Promise.all(a.map((function(n){return i(f,void 0,void 0,(function(){var r,i;return o(this,(function(o){switch(o.label){case 0:return[4,P((function(){return tt(n.encryptedSymmetricKey,e)}),new T("Could not decrypt a data key for data id "+n.documentID))];case 1:return r=o.sent(),[4,P((function(){return Q(r,c)}),new T("Could not encrypt data key for user "+t))];case 2:return i=o.sent(),[2,{documentID:n.documentID,encryptedSymmetricKey:v(i)}]}}))}))})))];case 5:return u=d.sent(),[4,this.service.giveAccess(t,u)];case 6:return rt(d.sent(),"Uploading the encrypted data keys for a user "+t+" failed"),[2,void 0]}}))}))},t.protocolVersion="1",t.apiUrl="https://api.blindnet.io",t.testUrl="https://test.blindnet.io",t}(),st={toBase64:v,fromBase64:p,toHex:S,fromHex:E};t.Blindnet=ot,t.error=D,t.util=st,Object.defineProperty(t,"__esModule",{value:!0})}));
